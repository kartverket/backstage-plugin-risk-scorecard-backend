apiVersion: apps/v1
kind: Deployment
metadata:
  name: kv-ros-backend
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kv-ros-backend
  template:
    metadata:
      labels:
        app: kv-ros-backend
    spec:
      imagePullSecrets:
        - name: gcp-auth
      containers:
        - name: kv-ros-backend
          image: europe-north1-docker.pkg.dev/spire-ros-5lmr/kv-ros/backend:latest
          ports:
            - name: http1
              containerPort: 8080
          volumeMounts:
            - name: sops-age-key
              mountPath: /etc/sops-secrets
              readOnly: true
          env:
            - name: GITHUB_APP_ID
              valueFrom:
                configMapKeyRef:
                  name: kv-ros-backend
                  key: GITHUB_APP_ID
            - name: GITHUB_INSTALLATION_ID
              valueFrom:
                configMapKeyRef:
                  name: kv-ros-backend
                  key: GITHUB_INSTALLATION_ID
            - name: GITHUB_PRIVATE_KEY_SECRET_NAME
              valueFrom:
                configMapKeyRef:
                  name: kv-ros-backend
                  key: GITHUB_PRIVATE_KEY_SECRET_NAME
            - name: ROS_URL
              valueFrom:
                configMapKeyRef:
                  name: kv-ros-backend
                  key: ROS_URL
            - name: JSON_SCHEMA_BASE_URL
              valueFrom:
                configMapKeyRef:
                  name: kv-ros-backend
                  key: JSON_SCHEMA_BASE_URL
            - name: ENTRA_ID_TENANT_ID
              valueFrom:
                configMapKeyRef:
                  name: kv-ros-backend
                  key: ENTRA_ID_TENANT_ID
            - name: SOPS_AGE_KEY
              valueFrom:
                secretKeyRef:
                  name: sops-age-private-key
                  key: SOPS_AGE_KEY
          resources:
            limits:
              cpu: 1000m
              memory: 512Mi
      volumes:
        - name: sops-age-key
          secret:
            secretName: sops-age-private-key